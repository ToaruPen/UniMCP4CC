# Unity MCP Bridge

MCP Bridge server that connects MCP clients (stdio) to Unity Editor.

## Requirements

- Node.js 18+ (for native fetch API support)
- Unity MCP Server package installed in your Unity project

## Quick Setup

### Option 1: Automatic Setup (Claude Code)

1. Open Unity Editor with the MCP Server package installed
2. Go to **Window > Unity MCP > Setup Claude Code**
3. Click the button to generate the configuration
4. Restart Claude Code

### Option 2: Manual Setup (Any MCP Client)

1. Install dependencies:
   ```bash
   cd Server~/mcp-bridge
   npm install
   ```

2. Configure your MCP client to launch this bridge as a stdio MCP server.

Example (Claude Code / `.mcp.json`-style):
   ```json
   {
     "mcpServers": {
       "unity": {
         "command": "node",
         "args": ["/path/to/Server~/mcp-bridge/index.js"],
         "cwd": "/path/to/your/unity/project"
       }
     }
   }
   ```

3. Start Unity Editor and your MCP client

## Configuration Files

The bridge reads configuration from:

1. `.unity-mcp-runtime.json` - Auto-generated by Unity, contains HTTP port
2. `mcp-bridge.config.json` - Optional bridge config (confirm allow/deny lists, etc.; `MCP_BRIDGE_CONFIG_PATH` overrides the path)
3. Environment variables:
   - `UNITY_HTTP_URL` - Unity HTTP server URL (default: `http://localhost:5051`)
   - `MCP_ALLOW_REMOTE_UNITY_HTTP_URL` - Allow non-local `UNITY_HTTP_URL` without warnings (default: `false`)
   - `MCP_STRICT_LOCAL_UNITY_HTTP_URL` - Refuse non-local `UNITY_HTTP_URL` and fall back to default URL (default: `false`)
   - `MCP_VERBOSE` - Set to `true` for verbose logging
   - `MCP_TOOL_TIMEOUT_MS` - Default tool call timeout in ms (default: `60000`)
   - `MCP_HEAVY_TOOL_TIMEOUT_MS` - Heavy tool call timeout in ms (default: `300000`)
   - `MCP_MAX_TOOL_TIMEOUT_MS` - Hard cap for tool call timeout in ms (default: `600000`)
   - `MCP_REQUIRE_CONFIRMATION` - Require explicit confirmation for potentially destructive tools (default: `true`)
   - `MCP_ENABLE_UNSAFE_EDITOR_INVOKE` - Expose `unity.editor.invokeStaticMethod` (default: `false`, always requires `__confirm: true`)
   - `MCP_BRIDGE_CONFIG_PATH` - Override the bridge config JSON path (default: `./mcp-bridge.config.json`)
   - `MCP_REQUIRE_UNAMBIGUOUS_TARGETS` - Block destructive calls that specify targets only by name (default: `true`)
   - `MCP_SCENE_LIST_MAX_DEPTH` - Max depth for internal `unity.scene.list` preflight (default: `20`, max: `100`)
   - `MCP_AMBIGUOUS_CANDIDATE_LIMIT` - Candidate list size in ambiguity errors (default: `25`, max: `200`)
   - `MCP_PREFLIGHT_SCENE_LIST_TIMEOUT_MS` - Timeout for internal scene-list preflight in ms (default: `MCP_TOOL_TIMEOUT_MS`)

### Bridge Tools

These tools are provided by the bridge itself (available even if Unity is not connected):

- `bridge.status` - Shows current URL, connection status, and timeout settings
- `bridge.reload_config` - Reloads `.unity-mcp-runtime.json` and updates the Unity HTTP URL
- `bridge.ping` - Calls Unity `/health` and returns the response

### Per-call Timeout Override (Optional)

If you need to override the timeout for a specific tool call, pass one of these keys in the tool arguments:

- `__timeoutMs`
- `__timeout_ms`
- `__timeout`

The bridge strips these keys before forwarding the call to Unity.

### unity.log.history Truncation (Optional, Opt-in)

To avoid forcing truncation on all users, log message/stackTrace truncation is opt-in for `unity.log.history` only.
Pass one or both keys in the tool arguments:

- `__maxMessageChars` / `__max_message_chars`
- `__maxStackTraceChars` / `__max_stack_trace_chars`

The bridge strips these keys before forwarding the call to Unity.

### Confirmation & Safety Flags

Some tools are treated as potentially destructive (delete/remove/build/import/project-settings changes).
To run them, pass:

- `__confirm: true`
- (optional) `__confirmNote: "why this is safe"`

`unity.editor.invokeStaticMethod` is special: it can execute arbitrary public static methods inside Unity Editor.
The bridge disables it by default (and hides it from `tools/list`) unless `MCP_ENABLE_UNSAFE_EDITOR_INVOKE=true`.
Even when enabled, it always requires `__confirm: true`.

### Confirmation Allow/Deny Lists (Optional)

You can control confirmation requirements with a JSON config file in the Unity project root (default: `mcp-bridge.config.json`).

Example:
```json
{
  "requireConfirmation": true,
  "confirm": {
    "allowlist": ["unity.scene.list", "unity.log.*"],
    "denylist": ["unity.asset.delete", "unity.*.destroy"]
  }
}
```

Notes:
- `allowlist`/`denylist` match the full tool name (e.g. `unity.scene.list`).
- Only `*` is supported as a wildcard; matching is case-insensitive.
- Priority: `denylist` > `unity.editor.invokeStaticMethod` (always confirm) > `allowlist` > built-in heuristics.
- `bridge.*` tools are always allowed and bypass allow/deny lists.
- `MCP_REQUIRE_CONFIRMATION=false` disables the built-in heuristics, but `denylist` still forces confirmation.
- Changes to the JSON file require restarting the bridge process.

If a destructive tool targets a scene object ambiguously, the bridge blocks it by default and returns a candidate list.
This includes:

- Name-only targets that match multiple GameObjects
- Hierarchy paths that are not unique (e.g. duplicated root names)

The bridge uses `unity.scene.list` internally to produce candidates; retry using an exact `path` from the returned list.

To override (not recommended), pass:

- `__allowAmbiguous: true`

### Argument Normalization (Unity-side key aliases)

Some Unity tools accept `gameObjectPath` (or `assetPath`) in addition to `path`.
The bridge automatically adds aliases so you can call tools with either key:

- `unity.create`: `type` → also sent as `primitiveType` (if missing)
- `path` → also sent as `gameObjectPath` (if missing)
- `unity.asset.delete`: `path` → also sent as `assetPath` (if missing)
- `unity.asset.createFolder`: `parentFolder` + `newFolderName` → also sent as `path` (if missing)
- `unity.asset.list`: `filter` like `t:Material` → also sent as `assetType` (if missing)
- `unity.component.setReference`: if `referenceType` is missing, bridge infers it (`asset` for `Assets/...` / `Packages/...`, otherwise `gameObject` or `component`) and may retry automatically. For `Sprite` fields, `setReference` may fail when `referencePath` points to a texture file (Texture2D main asset); use `unity.assetImport.listSprites` + `unity.component.setSpriteReference` to select an explicit Sprite sub-asset (no silent fallback).
- `unity.uitoolkit.*`: `gameObjectPath` / `gameObjectName` → also sent as `gameObject` (and `gameObject` → also sent as `gameObjectPath`) for better compatibility
- `unity.uitoolkit.runtime.*`: `query` / `elementName` → normalized into `selector` (Unity-side runtime APIs require a USS selector)

### Tool Overrides

- `unity.editor.listMenuItems`: Bridge provides a robust implementation that enumerates `MenuItem` attributes (supports `filter`).
- `unity.assetImport.setTextureType`: Bridge tool that sets `TextureImporter.textureType` (e.g. `Sprite`) and optionally reimports (requires `__confirm: true`). This is a safe fallback when `unity.import.*` tools are unavailable (they depend on the optional `LocalMcp.UnityServer.AssetImport.Editor` extension).
- `unity.assetImport.setSpritePixelsPerUnit`: Bridge tool that sets `TextureImporter.spritePixelsPerUnit` for Sprite textures (requires `__confirm: true`).
- `unity.assetImport.listSprites`: Bridge tool that lists Sprite sub-assets at a texture path (useful for sprite sheets).
- `unity.tilemap.setTile`: Bridge tool that sets a TileBase at a Tilemap cell (requires `__confirm: true`).
- `unity.tilemap.clearTile`: Bridge tool that clears a Tilemap cell (requires `__confirm: true`).
- `unity.component.add`: Bridge tool that validates target/type and returns explicit errors for ambiguous GameObject or component type failures. `removeConflictingRenderers: true` removes MeshFilter/MeshRenderer when adding SpriteRenderer (requires `__confirm: true`).
- `unity.component.setSpriteReference`: Bridge tool that sets a Sprite reference by `spriteName` (avoid implicit selection when multiple sprites exist).
- `unity.gameObject.createEmptySafe`: Bridge tool that creates an empty GameObject (optional `parentPath`/`active`).

### Optional Tools Annotation

Some tool families depend on Unity packages / optional extensions (e.g. Cinemachine, Timeline, UI Toolkit extension).
The bridge keeps these tools visible, but appends `[Optional] ...` notes to `tools/list` descriptions.

Note: Some optional families are implemented as Unity-side *extension assemblies*.
If the required extension assembly is not present in your Unity project, the call may fail with a misleading “package is not installed” message even when the Unity package is installed.
In this fork/package, `unity.cinemachine.*` / `unity.timeline.*` fall into that category (see the root `README.md` for details and workarounds).

## Troubleshooting

### E2E Smoke Test

With Unity Editor open (and the MCP server running), you can run a quick end-to-end smoke test via the bridge:

```bash
cd Server~/mcp-bridge
npm run smoke -- --project "/path/to/your/unity/project"
```

This will create a temporary GameObject, toggle `active` false→true, and then destroy it (confirm-gated).

### Connection Issues

1. Ensure Unity Editor is running
2. Check Unity Console for MCP Server status
3. Verify `.unity-mcp-runtime.json` exists in your project root
4. Set `MCP_VERBOSE=true` for detailed logs

### Node.js Version

This bridge requires Node.js 18+ for native fetch API support.
Check your version with: `node --version`
